--Now making a swtich to Staging layer.--

use warehouse WH_ANALYTICS;
use database olist_stage;
use schema public;

--starting to create clean tables in stage database--
--1. orders table--
create or replace table olist_orders_clean as 
select 
       ORDER_ID,
       CUSTOMER_ID,
       ORDER_STATUS,
       TRY_TO_TIMESTAMP(order_purchase_timestamp, 'YYYY-MM-DD HH24:MI:SS') AS order_purchase_ts,
       TRY_TO_TIMESTAMP(order_approved_at, 'YYYY-MM-DD HH24:MI:SS') AS order_approved_ts,
       TRY_TO_TIMESTAMP(order_delivered_carrier_date, 'YYYY-MM-DD HH24:MI:SS') AS delivered_carrier_ts,
        TRY_TO_TIMESTAMP(order_delivered_customer_date, 'YYYY-MM-DD HH24:MI:SS') AS delivered_customer_ts,
       TRY_TO_TIMESTAMP(order_estimated_delivery_date, 'YYYY-MM-DD HH24:MI:SS') AS estimated_delivery_ts
FROM  OLIST_RAW.MYSCHEMA.OLIST_ORDERS_RAW; 


select count(*) from OLIST_STAGE.PUBLIC.OLIST_ORDERS_CLEAN;

-- 2. Customers table--

CREATE TABLE olist_customers_clean AS
SELECT 
  customer_id,
  customer_unique_id,
  TRY_TO_NUMBER(customer_zip_code_prefix) AS customer_zip_code_prefix,
  customer_city,
  customer_state
FROM OLIST_RAW.MYSCHEMA.olist_customers_raw;

select count(*) from olist_customers_clean;

-- 3. Order Items-- (price/freight â†’ FLOAT)

CREATE TABLE olist_order_items_clean AS
SELECT 
  order_id,
  order_item_id,
  product_id,
  seller_id,
  TRY_TO_TIMESTAMP(shipping_limit_date, 'YYYY-MM-DD HH24:MI:SS') AS shipping_limit_date,
  TRY_TO_NUMBER(price) AS price,
  TRY_TO_NUMBER(freight_value) AS freight_value
FROM OLIST_RAW.MYSCHEMA.olist_order_items_raw;

select count(*) from olist_order_items_clean;

-- 4. Sellers --

CREATE TABLE olist_sellers_clean AS
SELECT 
  seller_id,
  TRY_TO_NUMBER(seller_zip_code_prefix) AS seller_zip_code_prefix,
  seller_city,
  seller_state
FROM OLIST_RAW.MYSCHEMA.olist_sellers_raw;

select count(*) from olist_sellers_clean;

-- 5. Payments --

CREATE TABLE olist_payments_clean AS
SELECT 
  order_id,
  TRY_TO_NUMBER(payment_sequential) AS payment_sequential,
  payment_type,
  TRY_TO_NUMBER(payment_installments) AS payment_installments,
  TRY_TO_NUMBER(payment_value) AS payment_value
FROM OLIST_RAW.MYSCHEMA.olist_payments_raw;

select count(*) from olist_payments_clean;

--6 Reviews --
CREATE TABLE olist_order_reviews_clean AS
SELECT
  review_id,
  order_id,
  TRY_TO_NUMBER(review_score) AS review_score,
  review_comment_title,
  review_comment_message,
  TRY_TO_TIMESTAMP(review_creation_date, 'YYYY-MM-DD HH24:MI:SS') AS review_creation_ts,
  TRY_TO_TIMESTAMP(review_answer_timestamp, 'YYYY-MM-DD HH24:MI:SS') AS review_answer_ts
FROM OLIST_RAW.MYSCHEMA.olist_order_reviews_raw;

select count(*) from olist_order_reviews_clean;


-- 7 Products --

CREATE TABLE olist_products_clean AS
SELECT
  product_id,
  product_category_name,
  TRY_TO_NUMBER(product_name_length) AS product_name_length,
  TRY_TO_NUMBER(product_description_length) AS product_description_length,
  TRY_TO_NUMBER(product_photos_qty) AS product_photos_qty,
  TRY_TO_NUMBER(product_weight_g) AS product_weight_g,
  TRY_TO_NUMBER(product_length_cm) AS product_length_cm,
  TRY_TO_NUMBER(product_height_cm) AS product_height_cm,
  TRY_TO_NUMBER(product_width_cm) AS product_width_cm
FROM OLIST_RAW.MYSCHEMA.olist_products_raw;

select count(*) from olist_products_clean;

--8 Category translations --

CREATE TABLE product_category_name_translation_clean AS
SELECT
  product_category_name,
  product_category_name_english
FROM OLIST_RAW.MYSCHEMA.product_category_name_translation_raw;

--9 Geolocation --

CREATE TABLE olist_geolocation_clean AS
SELECT
  TRY_TO_NUMBER(geolocation_zip_code_prefix) AS geolocation_zip_code_prefix,
  TRY_TO_NUMBER(geolocation_lat) AS geolocation_lat,
  TRY_TO_NUMBER(geolocation_lng) AS geolocation_lng,
  geolocation_city,
  geolocation_state
FROM OLIST_RAW.MYSCHEMA.olist_geolocation_raw;

select count(*) from olist_geolocation_clean;

-- We Now Have 9 Clean tables in our OLIST_STAGE DB--
